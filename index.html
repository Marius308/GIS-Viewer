<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comune Iași – Viewer</title>

  <!-- cache-bust -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Marker Cluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <!-- turf.js -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    html, body { height:100%; margin:0; }
    #map { height:100vh; width:100%; }

    /* etichete text cu HALO (fără casetă) */
    .leaflet-tooltip {
      background: transparent;
      border: none;
      box-shadow: none;
      color: #0c0c0c;
      font-weight: 600;
      text-shadow:
        0 0 2px #fff,
        0 0 4px #fff,
        0 0 6px #fff;
      padding: 2px 4px;
    }

    /* panou legendă + straturi (un singur box, stil IP) */
    .panel {
      background:#fff;
      padding:12px 14px;
      border-radius:12px;
      box-shadow:0 4px 20px rgba(0,0,0,.15);
      font-size:14px;
      line-height:1.5;
      max-width: 300px;
    }
    .panel h4{
      margin:0 0 8px; font-weight:700; font-size:16px;
    }
    .legend-row{display:flex; align-items:center; gap:8px; margin:6px 0; cursor:pointer;}
    .dot{width:14px; height:14px; border-radius:50%; border:1px solid rgba(0,0,0,.25); flex-shrink:0;}
    .divider{height:1px; background:#e8e8e8; margin:10px 0;}
    .btn {
      padding:6px 10px; border:0; border-radius:6px; cursor:pointer;
      background:#1976d2; color:#fff; font-weight:600;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}

    /* comutator baze hartă */
    .base-switch{
      position:absolute; left:12px; top:12px; z-index:1000;
      display:flex; gap:8px;
    }
    .base-switch .btn{background:#fff;color:#222;border:1px solid #ddd}
    .base-switch .btn.active{background:#1976d2;color:#fff;border-color:#1976d2}
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- comutator baze hartă -->
  <div class="base-switch" id="baseSwitch">
    <button class="btn active" data-base="osm">OSM</button>
    <button class="btn" data-base="sat">Satelit</button>
  </div>

  <script>
    // ===== 1) HARTA + baze =====
    const IASI_CENTER = L.latLng(47.1585, 27.5949); // Piața Unirii
    const map = L.map('map', { center: IASI_CENTER, zoom: 9 });

    const baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '© OpenStreetMap'
    }).addTo(map);

    const baseSAT = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19, attribution: '© Esri'
    });

    document.getElementById('baseSwitch').addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      document.querySelectorAll('#baseSwitch .btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      if(btn.dataset.base === 'sat'){ map.removeLayer(baseOSM); baseSAT.addTo(map); }
      else { map.removeLayer(baseSAT); baseOSM.addTo(map); }
    });

    // clustere
    const clusterGroup = L.markerClusterGroup({
      showCoverageOnHover:false,
      maxClusterRadius:60,
      disableClusteringAtZoom: 13
    });

    // straturi vector
    const layerCommuneLines = L.layerGroup(); // limite comune (linie punctată)
    const layerCountyLine   = L.layerGroup(); // limită județ (linie continuă)
    const layerPointsByInterval = {};         // puncte pe fiecare interval
    const ALL_POINTS = []; // pentru fitBounds
    let currentRouteLayer = null;
    let showRoute = true;  // switch din „Straturi”

    // ===== 2) culori + intervale DISTINCTE =====
    const PALETTE = [
      '#1f77b4', // 0–5
      '#17becf', // 5–10
      '#2ca02c', // 10–15
      '#b5bd00', // 15–20
      '#ffbf00', // 20–25
      '#ff7f0e', // 25–30
      '#d62728', // 30–35
      '#9467bd'  // >35
    ];
    function colorByDist(d){
      if(d<=5)  return PALETTE[0];
      if(d<=10) return PALETTE[1];
      if(d<=15) return PALETTE[2];
      if(d<=20) return PALETTE[3];
      if(d<=25) return PALETTE[4];
      if(d<=30) return PALETTE[5];
      if(d<=35) return PALETTE[6];
      return PALETTE[7];
    }
    function intervalLabel(d){
      if(d<=5)  return '0–5 km';
      if(d<=10) return '5–10 km';
      if(d<=15) return '10–15 km';
      if(d<=20) return '15–20 km';
      if(d<=25) return '20–25 km';
      if(d<=30) return '25–30 km';
      if(d<=35) return '30–35 km';
      return '>35 km';
    }
    const INTERVAL_ORDER = ['0–5 km','5–10 km','10–15 km','15–20 km','20–25 km','25–30 km','30–35 km','>35 km'];

    // ===== 3) SURSE DATE =====
    const UAT_ENDPOINT =
      'https://portal-gis.rowater.ro/maps/rest/services/Administrativ/Limita_UAT/MapServer/0/query';
    const WHERE_UAT = encodeURIComponent("Judet IN ('Iasi','Iași','Iaşi','IASI','IAȘI','IAŞI')");
    const UAT_URL = `${UAT_ENDPOINT}?where=${WHERE_UAT}&outFields=OBJECTID,Denumire,Judet` +
                    `&returnGeometry=true&outSR=4326&f=geojson&resultRecordCount=5000`;

    const COUNTY_ENDPOINT =
      'https://portal-gis.rowater.ro/maps/rest/services/Administrativ/Limita_Judete/MapServer/0/query';
    const COUNTY_URL = `${COUNTY_ENDPOINT}?where=1%3D1&outFields=OBJECTID,Nume,Judet,NUME_JUD` +
                       `&returnGeometry=true&outSR=4326&f=geojson`;

    // ===== 4) ÎNCĂRCARE DATE (robust, cu fallback) =====
    (async function init(){
      try{
        const resp = await fetch(UAT_URL, {mode:'cors'});
        const geo = await resp.json();
        if(!geo || !geo.features) throw new Error('Nu s-au găsit UAT-uri.');

        // 4.1 Limite comune (gri punctat)
        const communesOutline = L.geoJSON(geo, {
          style: {color:'#777', weight:1, opacity:0.9, dashArray:'4 4', fill:false}
        });
        layerCommuneLines.addLayer(communesOutline).addTo(map);

        // 4.2 Puncte (centroide) colorate
        geo.features.forEach(f=>{
          const name = f.properties.Denumire || 'Fără nume';
          const centroid = turf.centroid(f);
          const [lng, lat] = centroid.geometry.coordinates;
          const latlng = L.latLng(lat, lng);
          const d = map.distance(IASI_CENTER, latlng)/1000;
          const color = colorByDist(d);
          const interval = intervalLabel(d);

          const marker = L.circleMarker(latlng, {
            radius:8, fillColor:color, color:'#fff', weight:1, fillOpacity:0.95
          })
          .bindTooltip(name, {permanent:true, direction:'top', offset:[0,-10]})
          .bindPopup(`
            <details open class="popup-section">
              <summary><b>Date generale</b></summary>
              Distanță față de Iași: <b>${d.toFixed(1)} km</b><br/>
              UAT: ${name}
            </details>
            <details class="popup-section">
              <summary><b>Date geografice</b></summary>
              Climat: temperat-continental<br/>
              Altitudine min.: — m<br/>
              Altitudine max.: — m
            </details>
            <button class="btn" id="btn-${encodeURIComponent(name)}">Vezi ruta</button>
          `);

          marker.on('popupopen', ()=>{
            const btn = document.getElementById(`btn-${encodeURIComponent(name)}`);
            if(!btn) return;
            btn.onclick = async ()=>{
              btn.disabled = true; btn.textContent='Calculez ruta…';
              if(currentRouteLayer){ map.removeLayer(currentRouteLayer); currentRouteLayer=null; }
              try{
                const url = `https://router.project-osrm.org/route/v1/driving/`+
                            `${IASI_CENTER.lng},${IASI_CENTER.lat};${lng},${lat}`+
                            `?overview=full&geometries=geojson`;
                const r = await fetch(url);
                const j = await r.json();
                if(!j.routes || !j.routes[0]) throw new Error('Fără rută');
                const coords = j.routes[0].geometry.coordinates.map(([LNG,LAT])=>[LAT,LNG]);
                currentRouteLayer = L.polyline(coords,{color:color,weight:4});
                if(showRoute) currentRouteLayer.addTo(map);
                map.fitBounds(currentRouteLayer.getBounds().pad(0.25));
                const km  = (j.routes[0].distance/1000).toFixed(1);
                const min = Math.round(j.routes[0].duration/60);
                const extra = document.createElement('div');
                extra.style.marginTop='6px';
                extra.innerHTML=`Distanță pe drum: <b>${km} km</b> · Timp: <b>${min} min</b>`;
                btn.parentElement.appendChild(extra);
              }catch(e){ alert('Nu am putut calcula ruta acum.'); }
              finally{ btn.disabled=false; btn.textContent='Vezi ruta'; }
            };
          });

          if(!layerPointsByInterval[interval]) layerPointsByInterval[interval]=L.layerGroup();
          layerPointsByInterval[interval].addLayer(marker);
          ALL_POINTS.push(latlng);
        });

        // pune punctele în clustere
        Object.values(layerPointsByInterval).forEach(g=>clusterGroup.addLayer(g));
        map.addLayer(clusterGroup);
        if(ALL_POINTS.length) map.fitBounds(L.latLngBounds(ALL_POINTS).pad(0.25));

        // limită județ (din serviciu; dacă nu, fallback prin union)
        await addCountyBoundary(geo);

        // panou unic: legendă + straturi
        buildUnifiedPanel();

      }catch(err){
        console.error(err);
        alert('Nu am putut încărca datele UAT (server indisponibil).');
      }
    })();

    // ===== 5) LIMITA JUDEȚ =====
    async function addCountyBoundary(uatGeo){
      try{
        const r = await fetch(COUNTY_URL, {mode:'cors'});
        const g = await r.json();
        const found = (g.features||[]).find(f=>{
          const p = f.properties||{};
          const name = (p.Nume||p.Judet||p.NUME_JUD||'').toString().toLowerCase();
          return name.includes('iasi') || name.includes('iași') || name.includes('iaşi');
        });
        if(found){
          L.geoJSON(found, {style:{color:'#555', weight:2, fill:false}}).addTo(layerCountyLine);
          layerCountyLine.addTo(map);
          return;
        }
      }catch(e){ /* fallback below */ }

      // fallback: union UAT -> limită județ
      try{
        let union = null;
        (uatGeo.features||[]).forEach(f=>{
          union = union ? turf.union(union,f) : f;
        });
        if(union){
          L.geoJSON(union, {style:{color:'#555', weight:2, fill:false}}).addTo(layerCountyLine);
          layerCountyLine.addTo(map);
        }
      }catch(e){ console.warn('Nu am putut crea limita județ:', e); }
    }

    // ===== 6) PANOU UNIC: LEGENDĂ + STRATURI =====
    let activeInterval = null; // null = toate

    function buildUnifiedPanel(){
      const control = L.control({position:'topright'});
      control.onAdd = function(){
        const div = L.DomUtil.create('div','panel');

        // Legendă
        div.innerHTML = `<h4>Legendă</h4>`;
        const order = ['0–5 km','5–10 km','10–15 km','15–20 km','20–25 km','25–30 km','30–35 km','>35 km'];
        order.forEach((label,idx)=>{
          const color = PALETTE[idx] || PALETTE[PALETTE.length-1];
          const row = document.createElement('div');
          row.className='legend-row';
          row.dataset.interval = label;
          row.innerHTML = `<span class="dot" style="background:${color}"></span> <span>${label}</span>`;
          row.onclick = ()=>applyFilter(label);
          div.appendChild(row);
        });

        div.innerHTML += `<div class="divider"></div>`;

        // Straturi
        const layersHtml = `
          <h4>Straturi</h4>
          <label class="legend-row" style="cursor:default">
            <input type="checkbox" id="chk_points" checked style="margin-right:8px"> Puncte comune
          </label>
          <label class="legend-row" style="cursor:default">
            <input type="checkbox" id="chk_communes" checked style="margin-right:8px"> Limite comune
          </label>
          <label class="legend-row" style="cursor:default">
            <input type="checkbox" id="chk_county" checked style="margin-right:8px"> Limită județ
          </label>
          <label class="legend-row" style="cursor:default">
            <input type="checkbox" id="chk_route" checked style="margin-right:8px"> Rută (vizibilă)
          </label>
          <div class="divider"></div>
          <button class="btn" id="resetFilter">Resetare filtrare</button>
        `;
        const wrap = document.createElement('div');
        wrap.innerHTML = layersHtml;
        div.appendChild(wrap);

        setTimeout(()=>{
          document.getElementById('resetFilter').onclick = ()=>applyFilter(null);
          document.getElementById('chk_points').onchange = (e)=>{
            if(e.target.checked) applyFilter(activeInterval);
            else clusterGroup.clearLayers();
          };
          document.getElementById('chk_communes').onchange = (e)=>{
            if(e.target.checked) layerCommuneLines.addTo(map);
            else map.removeLayer(layerCommuneLines);
          };
          document.getElementById('chk_county').onchange = (e)=>{
            if(e.target.checked) layerCountyLine.addTo(map);
            else map.removeLayer(layerCountyLine);
          };
          document.getElementById('chk_route').onchange = (e)=>{
            showRoute = e.target.checked;
            if(currentRouteLayer){
              if(showRoute) currentRouteLayer.addTo(map);
              else map.removeLayer(currentRouteLayer);
            }
          };
        },0);

        L.DomEvent.disableClickPropagation(div);
        L.DomEvent.disableScrollPropagation(div);
        return div;
      };
      control.addTo(map);
    }

    function applyFilter(interval){
      activeInterval = interval;  // null = toate
      const pointsOn = document.getElementById('chk_points') ? document.getElementById('chk_points').checked : true;
      clusterGroup.clearLayers();
      if(!pointsOn) return;

      if(interval===null){
        Object.values(layerPointsByInterval).forEach(g=>clusterGroup.addLayer(g));
      }else{
        if(layerPointsByInterval[interval]) clusterGroup.addLayer(layerPointsByInterval[interval]);
      }
    }
  </script>
</body>
</html>
