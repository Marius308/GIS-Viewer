<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GIS Viewer Iași</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<style>
html, body, #map { height: 100%; margin: 0; padding: 0; }

.halo-label {
  color: #000;
  text-shadow:
    -1px -1px 2px #fff,
    1px -1px 2px #fff,
    -1px 1px 2px #fff,
    1px 1px 2px #fff;
  font-weight: bold;
  font-size: 13px;
}

.legend {
  background: white;
  padding: 10px;
  line-height: 1.4em;
  border-radius: 6px;
  box-shadow: 0 0 4px rgba(0,0,0,0.3);
}
.legend-title {
  font-weight: bold;
  margin-bottom: 5px;
}
.legend-color {
  display: inline-block;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  margin-right: 6px;
}
button.route-btn {
  background-color: #0066cc;
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: 4px;
  cursor: pointer;
}
button.route-btn:hover {
  background-color: #004c99;
}
</style>
</head>

<body>
<div id="map"></div>

<script>
// === 1. Inițializare hartă ===
var map = L.map('map').setView([47.16, 27.6], 10);

// Fundaluri
var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18, attribution: '&copy; OpenStreetMap'
}).addTo(map);
var sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  maxZoom: 18, attribution: '&copy; Esri'
});
var baseMaps = { "OSM": osm, "Satelit": sat };

// === 2. Funcție culori ===
function getColor(dist) {
  return dist <= 5  ? '#0055ff' :
         dist <= 10 ? '#00bfff' :
         dist <= 15 ? '#00cc44' :
         dist <= 20 ? '#a6d400' :
         dist <= 25 ? '#ffaa00' :
         dist <= 30 ? '#ff6600' :
         dist <= 35 ? '#cc0000' : '#9933cc';
}

// === 3. Date comune ===
var comuni = [
  { nume: "Iași", coord: [47.1585, 27.6014], dist: 0 },
  { nume: "Miroslava", coord: [47.1317, 27.4822], dist: 7 },
  { nume: "Holboca", coord: [47.1525, 27.6842], dist: 9 },
  { nume: "Bârnova", coord: [47.0679, 27.6145], dist: 10 },
  { nume: "Lețcani", coord: [47.1702, 27.4055], dist: 15 },
  { nume: "Scânteia", coord: [46.9335, 27.6749], dist: 25 },
  { nume: "Răducăneni", coord: [46.9446, 27.7767], dist: 30 },
  { nume: "Hălăucești", coord: [47.1705, 26.8993], dist: 35 }
];

// === 4. Marker cluster ===
var clusterGroup = L.markerClusterGroup({ showCoverageOnHover:false, maxClusterRadius:60 });
var labelLayers = []; // pentru tooltip-uri separate

comuni.forEach(c => {
  var marker = L.circleMarker(c.coord, {
    radius: 7,
    color: '#fff',
    fillColor: getColor(c.dist),
    fillOpacity: 0.9,
    weight: 1
  }).addTo(clusterGroup);

  // Tooltip permanent (halo)
  var tooltip = L.tooltip({
    permanent: true,
    direction: 'top',
    offset: [0, -8],
    className: 'halo-label'
  }).setContent(c.nume).setLatLng(c.coord).addTo(map);
  labelLayers.push(tooltip);
});
map.addLayer(clusterGroup);

// === 5. Ascunde etichetele sub zoom 9 ===
function updateLabelsVisibility() {
  const z = map.getZoom();
  labelLayers.forEach(l => {
    if (z >= 10) { map.addLayer(l); }
    else { map.removeLayer(l); }
  });
}
map.on('zoomend', updateLabelsVisibility);
updateLabelsVisibility();

// === 6. Limite comune din API ===
const layerAmenaj = L.layerGroup();

async function loadAmenaj() {
  const bbox = [46.9,26.5,47.6,28.1]; // Iași
  const url = `https://inspectorulpadurii.ro/api/layer/harti-amenajistice-stat?bbox=${bbox.join(',')},urn:ogc:def:crs:EPSG:4326`;
  try {
    const r = await fetch(url);
    const g = await r.json();
    L.geoJSON(g, { style:{ color:'#999', weight:1, dashArray:'4 3' } }).addTo(layerAmenaj);
  } catch(e) { console.warn(e); }
}
loadAmenaj();

// === 7. Legendă + Straturi ===
var legend = L.control({position:'topright'});
legend.onAdd = function() {
  var div = L.DomUtil.create('div','legend');
  div.innerHTML += `<div class='legend-title'>Legendă</div>`;
  var grades = [0,5,10,15,20,25,30,35];
  for (var i=0; i<grades.length; i++) {
    div.innerHTML += `<div><span class='legend-color' style='background:${getColor(grades[i]+1)}'></span>
      ${grades[i]}–${grades[i+1]||'>'} km</div>`;
  }
  div.innerHTML += `<hr><div class='legend-title'>Straturi</div>
    <label><input type='checkbox' id='chk_points' checked> Puncte comune</label><br>
    <label><input type='checkbox' id='chk_limits' checked> Limite comune</label>`;
  return div;
};
legend.addTo(map);

document.getElementById('chk_points').onchange = e => {
  if(e.target.checked) map.addLayer(clusterGroup); else map.removeLayer(clusterGroup);
};
document.getElementById('chk_limits').onchange = e => {
  if(e.target.checked) map.addLayer(layerAmenaj); else map.removeLayer(layerAmenaj);
};

L.control.layers(baseMaps, null, {collapsed:false, position:'topleft'}).addTo(map);

</script>
</body>
</html>
